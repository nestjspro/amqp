89153aaa5ae3d351361c5fc565dffd1d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dist_1 = require("../dist");
const testing_1 = require("@nestjs/testing");
jest.setTimeout(15000);
describe('AMQPModule Test', () => {
    let app;
    let amqpService;
    test('asdf', async () => {
        const module = await testing_1.Test.createTestingModule({
            imports: [
                dist_1.AMQPModule.forRoot({
                    logLevel: dist_1.AMQPLogLevel.ERROR,
                    connections: [
                        {
                            name: 'one',
                            url: 'amqp://rabbitmq:agaeq14@localhost:5672',
                            exchange: {
                                name: 'test-1',
                                type: 'topic',
                                options: {
                                    durable: true
                                }
                            },
                            queues: [
                                {
                                    name: '1',
                                    routingKey: '111',
                                    createBindings: true,
                                    options: {
                                        durable: false
                                    }
                                }
                            ]
                        }, {
                            name: 'two',
                            url: 'amqp://rabbitmq:agaeq14@localhost:5672',
                            exchange: {
                                name: 'test-2',
                                type: 'topic',
                                options: {
                                    durable: true
                                }
                            },
                            queues: [
                                {
                                    name: '2',
                                    routingKey: '222',
                                    createBindings: true,
                                    options: {
                                        durable: false
                                    }
                                }
                            ]
                        }
                    ]
                })
            ]
        }).compile();
        app = module.createNestApplication();
        await app.init();
        amqpService = module.get(dist_1.AMQPService);
        await expect(amqpService.connections[0].config).toBeTruthy();
        await expect(amqpService.connections.length).toEqual(2);
        amqpService.getConnection('two').subscribe(async (connection) => {
            await expect(connection.status).toEqual(dist_1.AMQPConnectionStatus.DISCONNECTED);
        });
        return new Promise(resolve => {
            expect(1).toEqual(1);
            resolve();
        });
    });
    test('Publish Message', async () => {
        return new Promise(resolve => {
            amqpService.getConnection('two').subscribe(connection => {
                connection.queue.publish({ exchange: 'test-1', message: Buffer.from('a'), routingKey: '1' });
                expect(connection.config).toBeTruthy();
                resolve();
            });
        });
    });
    test('AMQPMessage', () => {
        const message = new dist_1.AMQPMessage({
            content: Buffer.from(JSON.stringify({ a: 1, b: 2 }))
        });
        return expect(message.fromJSON()).toBeTruthy();
    });
    afterAll(async () => {
        amqpService.disconnect();
        await app.close();
        return new Promise(resolve => {
            setTimeout(() => {
                resolve();
            }, 1000);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdHRoZXdkYXZpcy93b3Jrc3BhY2UvbmVzdGpzcHJvL21vZHVsZXMvYW1xcC9saWIvdGVzdC9BTVFQTW9kdWxlVGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGtDQUFtRztBQUNuRyw2Q0FBc0Q7QUFHdEQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUV2QixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBRTdCLElBQUksR0FBRyxDQUFDO0lBQ1IsSUFBSSxXQUF3QixDQUFDO0lBRTdCLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFFcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBRXpELE9BQU8sRUFBRTtnQkFFTCxpQkFBVSxDQUFDLE9BQU8sQ0FBQztvQkFFZixRQUFRLEVBQUUsbUJBQVksQ0FBQyxLQUFLO29CQUM1QixXQUFXLEVBQUU7d0JBRVQ7NEJBRUksSUFBSSxFQUFFLEtBQUs7NEJBQ1gsR0FBRyxFQUFFLHdDQUF3Qzs0QkFDN0MsUUFBUSxFQUFFO2dDQUVOLElBQUksRUFBRSxRQUFRO2dDQUNkLElBQUksRUFBRSxPQUFPO2dDQUNiLE9BQU8sRUFBRTtvQ0FFTCxPQUFPLEVBQUUsSUFBSTtpQ0FFaEI7NkJBRUo7NEJBQ0QsTUFBTSxFQUFFO2dDQUVKO29DQUVJLElBQUksRUFBRSxHQUFHO29DQUNULFVBQVUsRUFBRSxLQUFLO29DQUNqQixjQUFjLEVBQUUsSUFBSTtvQ0FDcEIsT0FBTyxFQUFFO3dDQUVMLE9BQU8sRUFBRSxLQUFLO3FDQUVqQjtpQ0FFSjs2QkFFSjt5QkFFSixFQUFFOzRCQUVDLElBQUksRUFBRSxLQUFLOzRCQUNYLEdBQUcsRUFBRSx3Q0FBd0M7NEJBQzdDLFFBQVEsRUFBRTtnQ0FFTixJQUFJLEVBQUUsUUFBUTtnQ0FDZCxJQUFJLEVBQUUsT0FBTztnQ0FDYixPQUFPLEVBQUU7b0NBRUwsT0FBTyxFQUFFLElBQUk7aUNBRWhCOzZCQUVKOzRC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QUVQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYXR0aGV3ZGF2aXMvd29ya3NwYWNlL25lc3Rqc3Byby9tb2R1bGVzL2FtcXAvbGliL3Rlc3QvQU1RUE1vZHVsZVRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQU1RUFNlcnZpY2UsIEFNUVBNb2R1bGUsIEFNUVBMb2dMZXZlbCwgQU1RUENvbm5lY3Rpb25TdGF0dXMsIEFNUVBNZXNzYWdlIH0gZnJvbSAnLi4vZGlzdCc7XG5pbXBvcnQgeyBUZXN0aW5nTW9kdWxlLCBUZXN0IH0gZnJvbSAnQG5lc3Rqcy90ZXN0aW5nJztcbmltcG9ydCB7IENvbnN1bWVNZXNzYWdlIH0gZnJvbSAnYW1xcGxpYic7XG5cbmplc3Quc2V0VGltZW91dCgxNTAwMCk7XG5cbmRlc2NyaWJlKCdBTVFQTW9kdWxlIFRlc3QnLCAoKSA9PiB7XG5cbiAgICBsZXQgYXBwO1xuICAgIGxldCBhbXFwU2VydmljZTogQU1RUFNlcnZpY2U7XG5cbiAgICB0ZXN0KCdhc2RmJywgYXN5bmMgKCkgPT4ge1xuXG4gICAgICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG5cbiAgICAgICAgICAgIGltcG9ydHM6IFtcblxuICAgICAgICAgICAgICAgIEFNUVBNb2R1bGUuZm9yUm9vdCh7XG5cbiAgICAgICAgICAgICAgICAgICAgbG9nTGV2ZWw6IEFNUVBMb2dMZXZlbC5FUlJPUixcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbnM6IFtcblxuICAgICAgICAgICAgICAgICAgICAgICAge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ29uZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAnYW1xcDovL3JhYmJpdG1xOmFnYWVxMTRAbG9jYWxob3N0OjU2NzInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlOiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3Rlc3QtMScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd0b3BpYycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogdHJ1ZVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVldWVzOiBbXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnMScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0aW5nS2V5OiAnMTExJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZUJpbmRpbmdzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczoge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogZmFsc2VcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfSwge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3R3bycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAnYW1xcDovL3JhYmJpdG1xOmFnYWVxMTRAbG9jYWxob3N0OjU2NzInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlOiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3Rlc3QtMicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd0b3BpYycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogdHJ1ZVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVldWVzOiBbXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnMicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0aW5nS2V5OiAnMjIyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZUJpbmRpbmdzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczoge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogZmFsc2VcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIF1cblxuICAgICAgICB9KS5jb21waWxlKCk7XG5cbiAgICAgICAgYXBwID0gbW9kdWxlLmNyZWF0ZU5lc3RBcHBsaWNhdGlvbigpO1xuXG4gICAgICAgIGF3YWl0IGFwcC5pbml0KCk7XG5cbiAgICAgICAgYW1xcFNlcnZpY2UgPSBtb2R1bGUuZ2V0PEFNUVBTZXJ2aWNlPihBTVFQU2VydmljZSk7XG5cbiAgICAgICAgYXdhaXQgZXhwZWN0KGFtcXBTZXJ2aWNlLmNvbm5lY3Rpb25zWyAwIF0uY29uZmlnKS50b0JlVHJ1dGh5KCk7XG5cblxuICAgICAgICBhd2FpdCBleHBlY3QoYW1xcFNlcnZpY2UuY29ubmVjdGlvbnMubGVuZ3RoKS50b0VxdWFsKDIpO1xuXG4gICAgICAgIGFtcXBTZXJ2aWNlLmdldENvbm5lY3Rpb24oJ3R3bycpLnN1YnNjcmliZShhc3luYyBjb25uZWN0aW9uID0+IHtcblxuICAgICAgICAgICAgYXdhaXQgZXhwZWN0KGNvbm5lY3Rpb24uc3RhdHVzKS50b0VxdWFsKEFNUVBDb25uZWN0aW9uU3RhdHVzLkRJU0NPTk5FQ1RFRCk7XG5cbiAgICAgICAgfSk7XG5cblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4ocmVzb2x2ZSA9PiB7XG5cbiAgICAgICAgICAgIGV4cGVjdCgxKS50b0VxdWFsKDEpO1xuXG4gICAgICAgICAgICByZXNvbHZlKCk7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9KTtcblxuICAgIHRlc3QoJ1B1Ymxpc2ggTWVzc2FnZScsIGFzeW5jICgpID0+IHtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4ocmVzb2x2ZSA9PiB7XG5cbiAgICAgICAgICAgIGFtcXBTZXJ2aWNlLmdldENvbm5lY3Rpb24oJ3R3bycpLnN1YnNjcmliZShjb25uZWN0aW9uID0+IHtcblxuICAgICAgICAgICAgICAgIGNvbm5lY3Rpb24ucXVldWUucHVibGlzaCh7IGV4Y2hhbmdlOiAndGVzdC0xJywgbWVzc2FnZTogQnVmZmVyLmZyb20oJ2EnKSwgcm91dGluZ0tleTogJzEnIH0pO1xuXG4gICAgICAgICAgICAgICAgZXhwZWN0KGNvbm5lY3Rpb24uY29uZmlnKS50b0JlVHJ1dGh5KCk7XG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdBTVFQTWVzc2FnZScsICgpID0+IHtcblxuICAgICAgICBjb25zdCBtZXNzYWdlID0gbmV3IEFNUVBNZXNzYWdlKHtcblxuICAgICAgICAgICAgY29udGVudDogQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkoeyBhOiAxLCBiOiAyIH0pKVxuXG4gICAgICAgIH0gYXMgQ29uc3VtZU1lc3NhZ2UpO1xuXG4gICAgICAgIHJldHVybiBleHBlY3QobWVzc2FnZS5mcm9tSlNPTigpKS50b0JlVHJ1dGh5KCk7XG5cbiAgICB9KTtcblxuICAgIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcblxuICAgICAgICBhbXFwU2VydmljZS5kaXNjb25uZWN0KCk7XG5cbiAgICAgICAgYXdhaXQgYXBwLmNsb3NlKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4ge1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcblxuICAgICAgICAgICAgfSwgMTAwMCk7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9KTtcblxufSk7XG4iXSwidmVyc2lvbiI6M30=