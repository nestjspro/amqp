8434aee5594a382f91f256aa726153a4
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dist_1 = require("../dist");
const testing_1 = require("@nestjs/testing");
jest.setTimeout(15000);
describe('AMQPModule Test', () => {
    let app;
    let amqpService;
    test('asdf', async () => {
        const module = await testing_1.Test.createTestingModule({
            imports: [
                dist_1.AMQPModule.forRoot({
                    logLevel: dist_1.AMQPLogLevel.ERROR,
                    connections: [
                        {
                            name: 'one',
                            url: 'amqp://rabbitmq:agaeq14@localhost:5672',
                            exchange: {
                                name: 'test-1',
                                type: 'topic',
                                options: {
                                    durable: true
                                }
                            },
                            queues: [
                                {
                                    name: '1',
                                    routingKey: '111',
                                    createBindings: true,
                                    options: {
                                        durable: false
                                    }
                                }
                            ]
                        }, {
                            name: 'two',
                            url: 'amqp://rabbitmq:agaeq14@localhost:5672',
                            exchange: {
                                name: 'test-2',
                                type: 'topic',
                                options: {
                                    durable: true
                                }
                            },
                            queues: [
                                {
                                    name: '2',
                                    routingKey: '222',
                                    createBindings: true,
                                    options: {
                                        durable: false
                                    }
                                }
                            ]
                        }
                    ]
                })
            ]
        }).compile();
        app = module.createNestApplication();
        await app.init();
        amqpService = module.get(dist_1.AMQPService);
        amqpService.getConnection('two').subscribe(connection => {
            expect(connection.status).toEqual(dist_1.AMQPConnectionStatus.DISCONNECTED);
        });
        return new Promise(resolve => {
            expect(1).toEqual(1);
            resolve();
        });
        //
        // service.connections[ 0 ].reference$.subscribe(reference => {
        //     console.log(3);
        //     console.log(reference);
        //
        // });
        // console.log(4);
        // console.log(service.connections);
        // await publisher.connect();
        //
        // const channel = await publisher.amqp.createChannel();
        // console.log(channel);
        // console.log(await channel.assertExchange('test-2', 'topic'));
        //
        // await app.close();
    });
    test('Publish Message', async () => {
        amqpService.getConnection().subscribe(connection => {
            connection.queue.publish({ exchange: 'test-1', message: Buffer.from('a'), routingKey: '1' });
        });
    });
    afterAll(async () => {
        amqpService.disconnect();
        await app.close();
        return new Promise(resolve => {
            setTimeout(() => {
                resolve();
            }, 1000);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdHRoZXdkYXZpcy93b3Jrc3BhY2UvbmVzdGpzcHJvL21vZHVsZXMvYW1xcC9saWIvdGVzdC9BTVFQTW9kdWxlVGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGtDQUFzRjtBQUN0Riw2Q0FBc0Q7QUFFdEQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUV2QixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBRTdCLElBQUksR0FBRyxDQUFDO0lBQ1IsSUFBSSxXQUF3QixDQUFDO0lBRTdCLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFFcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBRXpELE9BQU8sRUFBRTtnQkFFTCxpQkFBVSxDQUFDLE9BQU8sQ0FBQztvQkFFZixRQUFRLEVBQUUsbUJBQVksQ0FBQyxLQUFLO29CQUM1QixXQUFXLEVBQUU7d0JBRVQ7NEJBRUksSUFBSSxFQUFFLEtBQUs7NEJBQ1gsR0FBRyxFQUFFLHdDQUF3Qzs0QkFDN0MsUUFBUSxFQUFFO2dDQUVOLElBQUksRUFBRSxRQUFRO2dDQUNkLElBQUksRUFBRSxPQUFPO2dDQUNiLE9BQU8sRUFBRTtvQ0FFTCxPQUFPLEVBQUUsSUFBSTtpQ0FFaEI7NkJBRUo7NEJBQ0QsTUFBTSxFQUFFO2dDQUVKO29DQUVJLElBQUksRUFBRSxHQUFHO29DQUNULFVBQVUsRUFBRSxLQUFLO29DQUNqQixjQUFjLEVBQUUsSUFBSTtvQ0FDcEIsT0FBTyxFQUFFO3dDQUVMLE9BQU8sRUFBRSxLQUFLO3FDQUVqQjtpQ0FFSjs2QkFFSjt5QkFFSixFQUFFOzRCQUVDLElBQUksRUFBRSxLQUFLOzRCQUNYLEdBQUcsRUFBRSx3Q0FBd0M7NEJBQzdDLFFBQVEsRUFBRTtnQ0FFTixJQUFJLEVBQUUsUUFBUTtnQ0FDZCxJQUFJLEVBQUUsT0FBTztnQ0FDYixPQUFPLEVBQUU7b0NBRUwsT0FBTyxFQUFFLElBQUk7aUNBRWhCOzZCQUVKOzRCQUNELE1BQU0sRUFBRTtnQ0FFSjtvQ0FFSSxJQUFJLEVBQUUsR0FBRztvQ0FDVCxVQUFVLEVBQUUsS0FBSztvQ0FDakIsY0FBYyxFQUFFLElBQUk7b0NBQ3BCLE9BQU8sRUFBRTt3Q0FFTCxPQUFPLEVBQUUsS0FBSztxQ0FFakI7aUNBRUo7NkJBRUo7eUJBRUo7cUJBRUo7aUJBRUosQ0FBQzthQUVMO1NBRUosQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsR0FBRyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRXJDLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWpCLFdBQVcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLGtCQUFXLENBQUMsQ0FBQztRQUV0QyxXQUFXLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUVwRCxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQywyQkFBb0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUV6RSxDQUFDLENBQUMsQ0FBQztRQUdILE9BQU8sSUFBSSxPQUFPLENBQU8sT0FBTyxDQUFDLEVBQUU7WUFFL0IsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVyQixPQUFPLEVBQUUsQ0FBQztRQUVkLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRTtRQUNGLCtEQUErRDtRQUMvRCxzQkFBc0I7UUFDdEIsOEJBQThCO1FBQzlCLEVBQUU7UUFDRixNQUFNO1FBQ04sa0JBQWtCO1FBQ2xCLG9DQUFvQztRQUNwQyw2QkFBNkI7UUFDN0IsRUFBRTtRQUNGLHdEQUF3RDtRQUN4RCx3QkFBd0I7UUFDeEIsZ0VBQWdFO1FBQ2hFLEVBQUU7UUFDRixxQkFBcUI7SUFHekIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFFL0IsV0FBVyxDQUFDLGFBQWEsRUFBRSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUUvQyxVQUFVLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFFakcsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxLQUFLLElBQUksRUFBRTtRQUVoQixXQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7UUFFekIsTUFBTSxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFbEIsT0FBTyxJQUFJLE9BQU8sQ0FBTyxPQUFPLENBQUMsRUFBRTtZQUUvQixVQUFVLENBQUMsR0FBRyxFQUFFO2dCQUVaLE9BQU8sRUFBRSxDQUFDO1lBRWQsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBRWIsQ0FBQyxDQUFDLENBQUM7SUFFUCxDQUFDLENBQUMsQ0FBQztBQUVQLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9tYXR0aGV3ZGF2aXMvd29ya3NwYWNlL25lc3Rqc3Byby9tb2R1bGVzL2FtcXAvbGliL3Rlc3QvQU1RUE1vZHVsZVRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQU1RUFNlcnZpY2UsIEFNUVBNb2R1bGUsIEFNUVBMb2dMZXZlbCwgQU1RUENvbm5lY3Rpb25TdGF0dXMgfSBmcm9tICcuLi9kaXN0JztcbmltcG9ydCB7IFRlc3RpbmdNb2R1bGUsIFRlc3QgfSBmcm9tICdAbmVzdGpzL3Rlc3RpbmcnO1xuXG5qZXN0LnNldFRpbWVvdXQoMTUwMDApO1xuXG5kZXNjcmliZSgnQU1RUE1vZHVsZSBUZXN0JywgKCkgPT4ge1xuXG4gICAgbGV0IGFwcDtcbiAgICBsZXQgYW1xcFNlcnZpY2U6IEFNUVBTZXJ2aWNlO1xuXG4gICAgdGVzdCgnYXNkZicsIGFzeW5jICgpID0+IHtcblxuICAgICAgICBjb25zdCBtb2R1bGU6IFRlc3RpbmdNb2R1bGUgPSBhd2FpdCBUZXN0LmNyZWF0ZVRlc3RpbmdNb2R1bGUoe1xuXG4gICAgICAgICAgICBpbXBvcnRzOiBbXG5cbiAgICAgICAgICAgICAgICBBTVFQTW9kdWxlLmZvclJvb3Qoe1xuXG4gICAgICAgICAgICAgICAgICAgIGxvZ0xldmVsOiBBTVFQTG9nTGV2ZWwuRVJST1IsXG4gICAgICAgICAgICAgICAgICAgIGNvbm5lY3Rpb25zOiBbXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICdvbmUnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJ2FtcXA6Ly9yYWJiaXRtcTphZ2FlcTE0QGxvY2FsaG9zdDo1NjcyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZToge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICd0ZXN0LTEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAndG9waWMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGU6IHRydWVcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlczogW1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJzEnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm91dGluZ0tleTogJzExMScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVCaW5kaW5nczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGU6IGZhbHNlXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH0sIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICd0d28nLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJ2FtcXA6Ly9yYWJiaXRtcTphZ2FlcTE0QGxvY2FsaG9zdDo1NjcyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNoYW5nZToge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWU6ICd0ZXN0LTInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAndG9waWMnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zOiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGU6IHRydWVcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXVlczogW1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJzInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcm91dGluZ0tleTogJzIyMicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcmVhdGVCaW5kaW5nczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGR1cmFibGU6IGZhbHNlXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdXG5cbiAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBdXG5cbiAgICAgICAgICAgICAgICB9KVxuXG4gICAgICAgICAgICBdXG5cbiAgICAgICAgfSkuY29tcGlsZSgpO1xuXG4gICAgICAgIGFwcCA9IG1vZHVsZS5jcmVhdGVOZXN0QXBwbGljYXRpb24oKTtcblxuICAgICAgICBhd2FpdCBhcHAuaW5pdCgpO1xuXG4gICAgICAgIGFtcXBTZXJ2aWNlID0gbW9kdWxlLmdldChBTVFQU2VydmljZSk7XG5cbiAgICAgICAgYW1xcFNlcnZpY2UuZ2V0Q29ubmVjdGlvbigndHdvJykuc3Vic2NyaWJlKGNvbm5lY3Rpb24gPT4ge1xuXG4gICAgICAgICAgICBleHBlY3QoY29ubmVjdGlvbi5zdGF0dXMpLnRvRXF1YWwoQU1RUENvbm5lY3Rpb25TdGF0dXMuRElTQ09OTkVDVEVEKTtcblxuICAgICAgICB9KTtcblxuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTx2b2lkPihyZXNvbHZlID0+IHtcblxuICAgICAgICAgICAgZXhwZWN0KDEpLnRvRXF1YWwoMSk7XG5cbiAgICAgICAgICAgIHJlc29sdmUoKTtcblxuICAgICAgICB9KTtcblxuICAgICAgICAvL1xuICAgICAgICAvLyBzZXJ2aWNlLmNvbm5lY3Rpb25zWyAwIF0ucmVmZXJlbmNlJC5zdWJzY3JpYmUocmVmZXJlbmNlID0+IHtcbiAgICAgICAgLy8gICAgIGNvbnNvbGUubG9nKDMpO1xuICAgICAgICAvLyAgICAgY29uc29sZS5sb2cocmVmZXJlbmNlKTtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gfSk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKDQpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhzZXJ2aWNlLmNvbm5lY3Rpb25zKTtcbiAgICAgICAgLy8gYXdhaXQgcHVibGlzaGVyLmNvbm5lY3QoKTtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gY29uc3QgY2hhbm5lbCA9IGF3YWl0IHB1Ymxpc2hlci5hbXFwLmNyZWF0ZUNoYW5uZWwoKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coY2hhbm5lbCk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKGF3YWl0IGNoYW5uZWwuYXNzZXJ0RXhjaGFuZ2UoJ3Rlc3QtMicsICd0b3BpYycpKTtcbiAgICAgICAgLy9cbiAgICAgICAgLy8gYXdhaXQgYXBwLmNsb3NlKCk7XG5cblxuICAgIH0pO1xuXG4gICAgdGVzdCgnUHVibGlzaCBNZXNzYWdlJywgYXN5bmMgKCkgPT4ge1xuXG4gICAgICAgIGFtcXBTZXJ2aWNlLmdldENvbm5lY3Rpb24oKS5zdWJzY3JpYmUoY29ubmVjdGlvbiA9PiB7XG5cbiAgICAgICAgICAgIGNvbm5lY3Rpb24ucXVldWUucHVibGlzaCh7IGV4Y2hhbmdlOiAndGVzdC0xJywgbWVzc2FnZTogQnVmZmVyLmZyb20oJ2EnKSwgcm91dGluZ0tleTogJzEnIH0pO1xuXG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJBbGwoYXN5bmMgKCkgPT4ge1xuXG4gICAgICAgIGFtcXBTZXJ2aWNlLmRpc2Nvbm5lY3QoKTtcblxuICAgICAgICBhd2FpdCBhcHAuY2xvc2UoKTtcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8dm9pZD4ocmVzb2x2ZSA9PiB7XG5cbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuXG4gICAgICAgICAgICAgICAgcmVzb2x2ZSgpO1xuXG4gICAgICAgICAgICB9LCAxMDAwKTtcblxuICAgICAgICB9KTtcblxuICAgIH0pO1xuXG59KTtcbiJdLCJ2ZXJzaW9uIjozfQ==