820e37438857a3b19e989da5656d1334
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const dist_1 = require("../dist");
const testing_1 = require("@nestjs/testing");
jest.setTimeout(15000);
describe('AMQPModule Test', () => {
    let app;
    let amqpService;
    test('asdf', async () => {
        const module = await testing_1.Test.createTestingModule({
            imports: [
                dist_1.AMQPModule.forRoot({
                    logLevel: dist_1.AMQPLogLevel.ERROR,
                    connections: [
                        {
                            name: 'one',
                            url: 'amqp://rabbitmq:agaeq14@localhost:5672',
                            exchange: {
                                name: 'test-1',
                                type: 'topic',
                                options: {
                                    durable: true
                                }
                            },
                            queues: [
                                {
                                    name: '1',
                                    routingKey: '111',
                                    createBindings: true,
                                    options: {
                                        durable: false
                                    }
                                }
                            ]
                        }, {
                            name: 'two',
                            url: 'amqp://rabbitmq:agaeq14@localhost:5672',
                            exchange: {
                                name: 'test-2',
                                type: 'topic',
                                options: {
                                    durable: true
                                }
                            },
                            queues: [
                                {
                                    name: '2',
                                    routingKey: '222',
                                    createBindings: true,
                                    options: {
                                        durable: false
                                    }
                                }
                            ]
                        }
                    ]
                })
            ]
        }).compile();
        app = module.createNestApplication();
        await app.init();
        amqpService = module.get(dist_1.AMQPService);
        amqpService.getConnection('two').subscribe(connection => {
            expect(connection.status).toEqual(dist_1.AMQPConnectionStatus.DISCONNECTED);
        });
        return new Promise(resolve => {
            expect(1).toEqual(1);
            resolve();
        });
        //
        // service.connections[ 0 ].reference$.subscribe(reference => {
        //     console.log(3);
        //     console.log(reference);
        //
        // });
        // console.log(4);
        // console.log(service.connections);
        // await publisher.connect();
        //
        // const channel = await publisher.amqp.createChannel();
        // console.log(channel);
        // console.log(await channel.assertExchange('test-2', 'topic'));
        //
        // await app.close();
    });
    test('Publish Message', async () => {
        return new Promise(resolve => {
            amqpService.getConnection().subscribe(connection => {
                connection.queue.publish({ exchange: 'test-1', message: Buffer.from('a'), routingKey: '1' });
                resolve();
            });
        });
    });
    afterAll(async () => {
        amqpService.disconnect();
        await app.close();
        return new Promise(resolve => {
            setTimeout(() => {
                resolve();
            }, 1000);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL21hdHRoZXdkYXZpcy93b3Jrc3BhY2UvbmVzdGpzcHJvL21vZHVsZXMvYW1xcC9saWIvdGVzdC9BTVFQTW9kdWxlVGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQUFBLGtDQUFzRjtBQUN0Riw2Q0FBc0Q7QUFFdEQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUV2QixRQUFRLENBQUMsaUJBQWlCLEVBQUUsR0FBRyxFQUFFO0lBRTdCLElBQUksR0FBRyxDQUFDO0lBQ1IsSUFBSSxXQUF3QixDQUFDO0lBRTdCLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFFcEIsTUFBTSxNQUFNLEdBQWtCLE1BQU0sY0FBSSxDQUFDLG1CQUFtQixDQUFDO1lBRXpELE9BQU8sRUFBRTtnQkFFTCxpQkFBVSxDQUFDLE9BQU8sQ0FBQztvQkFFZixRQUFRLEVBQUUsbUJBQVksQ0FBQyxLQUFLO29CQUM1QixXQUFXLEVBQUU7d0JBRVQ7NEJBRUksSUFBSSxFQUFFLEtBQUs7NEJBQ1gsR0FBRyxFQUFFLHdDQUF3Qzs0QkFDN0MsUUFBUSxFQUFFO2dDQUVOLElBQUksRUFBRSxRQUFRO2dDQUNkLElBQUksRUFBRSxPQUFPO2dDQUNiLE9BQU8sRUFBRTtvQ0FFTCxPQUFPLEVBQUUsSUFBSTtpQ0FFaEI7NkJBRUo7NEJBQ0QsTUFBTSxFQUFFO2dDQUVKO29DQUVJLElBQUksRUFBRSxHQUFHO29DQUNULFVBQVUsRUFBRSxLQUFLO29DQUNqQixjQUFjLEVBQUUsSUFBSTtvQ0FDcEIsT0FBTyxFQUFFO3dDQUVMLE9BQU8sRUFBRSxLQUFLO3FDQUVqQjtpQ0FFSjs2QkFFSjt5QkFFSixFQUFFOzRCQUVDLElBQUksRUFBRSxLQUFLOzRCQUNYLEdBQUcsRUFBRSx3Q0FBd0M7NEJBQzdDLFFBQVEsRUFBRTtnQ0FFTixJQUFJLEVBQUUsUUFBUTtnQ0FDZCxJQUFJLEVBQUUsT0FBTztnQ0FDYixPQUFPLEVBQUU7b0NBRUwsT0FBTyxFQUFFLElBQUk7aUNBRWhCOzZCQUVKOzRCQUNELE1BQU0sRUFBRTtnQ0FFSjtvQ0FFSSxJQUFJLEVBQUUsR0FBRztvQ0FDVCxVQUFVLEVBQUUsS0FBSztvQ0FDakIsY0FBYyxFQUFFLElBQUk7b0NBQ3BCLE9BQU8sRUFBRTt3Q0FFTCxPQUFPLEVBQUUsS0FBSztxQ0FFakI7aUNBRUo7NkJBRUo7eUJBRUo7cUJBRUo7aUJBRUosQ0FBQzthQUVMO1NBRUosQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBRWIsR0FBRyxHQUFHLE1BQU0sQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRXJDLE1BQU0sR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWpCLFdBQVcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLGtCQUFXLENBQUMsQ0FBQztRQUV0QyxXQUFXLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsRUFBRTtZQUVwRCxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQywyQkFBb0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUV6RSxDQUFDLENBQUMsQ0FBQztRQUdILE9BQU8sSUFBSSxPQUFPLENBQU8sT0FBTyxDQUFDLEVBQUU7WUFFL0IsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUVyQixPQUFPLEVBQUUsQ0FBQztRQUVkLENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRTtRQUNGLCtEQUErRDtRQUMvRCxzQkFBc0I7UUFDdEIsOEJBQThCO1FBQzlCLEVBQUU7UUFDRixNQUFNO1FBQ04sa0JBQWtCO1FBQ2xCLG9DQUFvQztRQUNwQyw2QkFBNkI7UUFDN0IsRUFBRTtRQUNGLHdEQUF3RDtRQUN4RCx3QkFBd0I7UUFDeEIsZ0VBQWdFO1FBQ2hFLEVBQUU7UUFDRixxQkFBcUI7SUFHekIsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsaUJBQWlCLEVBQUUsS0FBSyxJQUFJLEVBQUU7UUFFL0IsT0FBTyxJQUFJLE9BQU8sQ0FBTyxPQUFPLENBQUMsRUFBRTtZQUUvQixXQUFXLENBQUMsYUFBYSxFQUFFLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxFQUFFO2dCQUUvQyxVQUFVLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7Z0JBRTdGLE9BQU8sRUFBRSxDQUFDO1lBRWQsQ0FBQyxDQUFDLENBQUM7UUFFUCxDQUFDLENBQUMsQ0FBQztJQUVQLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLEtBQUssSUFBSSxFQUFFO1FBRWhCLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUV6QixNQUFNLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVsQixPQUFPLElBQUksT0FBTyxDQUFPLE9BQU8sQ0FBQyxFQUFFO1lBRS9CLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBRVosT0FBTyxFQUFFLENBQUM7WUFFZCxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFFYixDQUFDLENBQUMsQ0FBQztJQUVQLENBQUMsQ0FBQyxDQUFDO0FBRVAsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL21hdHRoZXdkYXZpcy93b3Jrc3BhY2UvbmVzdGpzcHJvL21vZHVsZXMvYW1xcC9saWIvdGVzdC9BTVFQTW9kdWxlVGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBTVFQU2VydmljZSwgQU1RUE1vZHVsZSwgQU1RUExvZ0xldmVsLCBBTVFQQ29ubmVjdGlvblN0YXR1cyB9IGZyb20gJy4uL2Rpc3QnO1xuaW1wb3J0IHsgVGVzdGluZ01vZHVsZSwgVGVzdCB9IGZyb20gJ0BuZXN0anMvdGVzdGluZyc7XG5cbmplc3Quc2V0VGltZW91dCgxNTAwMCk7XG5cbmRlc2NyaWJlKCdBTVFQTW9kdWxlIFRlc3QnLCAoKSA9PiB7XG5cbiAgICBsZXQgYXBwO1xuICAgIGxldCBhbXFwU2VydmljZTogQU1RUFNlcnZpY2U7XG5cbiAgICB0ZXN0KCdhc2RmJywgYXN5bmMgKCkgPT4ge1xuXG4gICAgICAgIGNvbnN0IG1vZHVsZTogVGVzdGluZ01vZHVsZSA9IGF3YWl0IFRlc3QuY3JlYXRlVGVzdGluZ01vZHVsZSh7XG5cbiAgICAgICAgICAgIGltcG9ydHM6IFtcblxuICAgICAgICAgICAgICAgIEFNUVBNb2R1bGUuZm9yUm9vdCh7XG5cbiAgICAgICAgICAgICAgICAgICAgbG9nTGV2ZWw6IEFNUVBMb2dMZXZlbC5FUlJPUixcbiAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbnM6IFtcblxuICAgICAgICAgICAgICAgICAgICAgICAge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ29uZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAnYW1xcDovL3JhYmJpdG1xOmFnYWVxMTRAbG9jYWxob3N0OjU2NzInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlOiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3Rlc3QtMScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd0b3BpYycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogdHJ1ZVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVldWVzOiBbXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnMScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0aW5nS2V5OiAnMTExJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZUJpbmRpbmdzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczoge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogZmFsc2VcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfSwge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3R3bycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiAnYW1xcDovL3JhYmJpdG1xOmFnYWVxMTRAbG9jYWxob3N0OjU2NzInLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2hhbmdlOiB7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZTogJ3Rlc3QtMicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd0b3BpYycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdGlvbnM6IHtcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogdHJ1ZVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcXVldWVzOiBbXG5cbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lOiAnMicsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0aW5nS2V5OiAnMjIyJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNyZWF0ZUJpbmRpbmdzOiB0cnVlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0aW9uczoge1xuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZHVyYWJsZTogZmFsc2VcblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgICAgIF1cblxuICAgICAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgIF1cblxuICAgICAgICB9KS5jb21waWxlKCk7XG5cbiAgICAgICAgYXBwID0gbW9kdWxlLmNyZWF0ZU5lc3RBcHBsaWNhdGlvbigpO1xuXG4gICAgICAgIGF3YWl0IGFwcC5pbml0KCk7XG5cbiAgICAgICAgYW1xcFNlcnZpY2UgPSBtb2R1bGUuZ2V0KEFNUVBTZXJ2aWNlKTtcblxuICAgICAgICBhbXFwU2VydmljZS5nZXRDb25uZWN0aW9uKCd0d28nKS5zdWJzY3JpYmUoY29ubmVjdGlvbiA9PiB7XG5cbiAgICAgICAgICAgIGV4cGVjdChjb25uZWN0aW9uLnN0YXR1cykudG9FcXVhbChBTVFQQ29ubmVjdGlvblN0YXR1cy5ESVNDT05ORUNURUQpO1xuXG4gICAgICAgIH0pO1xuXG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4ge1xuXG4gICAgICAgICAgICBleHBlY3QoMSkudG9FcXVhbCgxKTtcblxuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuXG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vXG4gICAgICAgIC8vIHNlcnZpY2UuY29ubmVjdGlvbnNbIDAgXS5yZWZlcmVuY2UkLnN1YnNjcmliZShyZWZlcmVuY2UgPT4ge1xuICAgICAgICAvLyAgICAgY29uc29sZS5sb2coMyk7XG4gICAgICAgIC8vICAgICBjb25zb2xlLmxvZyhyZWZlcmVuY2UpO1xuICAgICAgICAvL1xuICAgICAgICAvLyB9KTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coNCk7XG4gICAgICAgIC8vIGNvbnNvbGUubG9nKHNlcnZpY2UuY29ubmVjdGlvbnMpO1xuICAgICAgICAvLyBhd2FpdCBwdWJsaXNoZXIuY29ubmVjdCgpO1xuICAgICAgICAvL1xuICAgICAgICAvLyBjb25zdCBjaGFubmVsID0gYXdhaXQgcHVibGlzaGVyLmFtcXAuY3JlYXRlQ2hhbm5lbCgpO1xuICAgICAgICAvLyBjb25zb2xlLmxvZyhjaGFubmVsKTtcbiAgICAgICAgLy8gY29uc29sZS5sb2coYXdhaXQgY2hhbm5lbC5hc3NlcnRFeGNoYW5nZSgndGVzdC0yJywgJ3RvcGljJykpO1xuICAgICAgICAvL1xuICAgICAgICAvLyBhd2FpdCBhcHAuY2xvc2UoKTtcblxuXG4gICAgfSk7XG5cbiAgICB0ZXN0KCdQdWJsaXNoIE1lc3NhZ2UnLCBhc3luYyAoKSA9PiB7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4ge1xuXG4gICAgICAgICAgICBhbXFwU2VydmljZS5nZXRDb25uZWN0aW9uKCkuc3Vic2NyaWJlKGNvbm5lY3Rpb24gPT4ge1xuXG4gICAgICAgICAgICAgICAgY29ubmVjdGlvbi5xdWV1ZS5wdWJsaXNoKHsgZXhjaGFuZ2U6ICd0ZXN0LTEnLCBtZXNzYWdlOiBCdWZmZXIuZnJvbSgnYScpLCByb3V0aW5nS2V5OiAnMScgfSk7XG5cbiAgICAgICAgICAgICAgICByZXNvbHZlKCk7XG5cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICB9KTtcblxuICAgIGFmdGVyQWxsKGFzeW5jICgpID0+IHtcblxuICAgICAgICBhbXFwU2VydmljZS5kaXNjb25uZWN0KCk7XG5cbiAgICAgICAgYXdhaXQgYXBwLmNsb3NlKCk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPHZvaWQ+KHJlc29sdmUgPT4ge1xuXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcblxuICAgICAgICAgICAgICAgIHJlc29sdmUoKTtcblxuICAgICAgICAgICAgfSwgMTAwMCk7XG5cbiAgICAgICAgfSk7XG5cbiAgICB9KTtcblxufSk7XG4iXSwidmVyc2lvbiI6M30=